<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthSyncIQ - Patient Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for Brand Colors - Consistent with HealthSyncIQ Brand */
        :root {
            --hs-color-primary-dark: #1A3E62; /* Deep Blue */
            --hs-color-primary-medium: #2B5A8F;
            --hs-color-primary-light: #5A8FC2;

            --hs-color-accent-green: #3CB371; /* Medium Sea Green */
            --hs-color-accent-aqua: #20B2AA; /* Light Sea Green */

            --hs-color-neutral-white: #FFFFFF;
            --hs-color-neutral-light-grey: #F8F9FA;
            --hs-color-neutral-medium-grey: #E9ECEF;
            --hs-color-neutral-dark-grey: #ADB5BD;
            --hs-color-neutral-text-dark: #343A40;
            
            --hs-font-primary: 'Inter', sans-serif;
            
            --hs-spacing-xs: 4px;
            --hs-spacing-sm: 8px;
            --hs-spacing-md: 16px;
            --hs-spacing-lg: 24px;
            --hs-spacing-xl: 32px;
            --hs-spacing-xxl: 48px;
        }

        /* Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--hs-font-primary);
            line-height: 1.6;
            color: var(--hs-color-neutral-text-dark);
            background-color: var(--hs-color-neutral-light-grey);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header - Consistent with existing brand */
        .header {
            background-color: var(--hs-color-primary-dark);
            color: var(--hs-color-neutral-white);
            padding: var(--hs-spacing-lg) var(--hs-spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header .logo {
            font-size: 1.8em;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--hs-color-neutral-white);
            text-decoration: none;
        }

        .header nav ul {
            list-style: none;
            display: flex;
            gap: var(--hs-spacing-xl);
        }

        .header nav a {
            color: var(--hs-color-neutral-white);
            font-weight: 500;
            padding: var(--hs-spacing-sm) 0;
            position: relative;
        }

        .header nav a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--hs-color-accent-aqua);
            transition: width 0.3s ease;
        }

        .header nav a:hover::after,
        .header nav a.active::after { /* Active state for current page */
            width: 100%;
        }

        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            padding: var(--hs-spacing-xxl) var(--hs-spacing-lg);
            max-width: 1200px;
            margin: 0 auto; /* Center content */
            width: 100%;
        }

        .main-content h1 {
            color: var(--hs-color-primary-dark);
            margin-bottom: var(--hs-spacing-xl);
            text-align: center;
            font-size: 2.5em;
        }

        /* Search Container */
        .search-container {
            background-color: var(--hs-color-neutral-white);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: var(--hs-spacing-xl);
            margin-bottom: var(--hs-spacing-xxl);
            border: 1px solid var(--hs-color-neutral-medium-grey);
            display: flex;
            align-items: center;
            gap: var(--hs-spacing-md);
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }

        .search-container .form-group {
            flex-grow: 1; /* Allow input to take available space */
            margin-bottom: 0; /* Remove default margin */
        }

        .search-container .form-group label {
            font-size: 1.1em;
            margin-bottom: var(--hs-spacing-sm);
            color: var(--hs-color-primary-dark);
        }

        .search-container input[type="text"] {
            width: 100%;
            padding: var(--hs-spacing-md);
            border: 1px solid var(--hs-color-neutral-medium-grey);
            border-radius: 5px;
            font-family: var(--hs-font-primary);
            font-size: 1.1em;
            color: var(--hs-color-neutral-text-dark);
            background-color: var(--hs-color-neutral-white);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .search-container input[type="text"]:focus {
            border-color: var(--hs-color-primary-medium);
            outline: none;
            box-shadow: 0 0 0 3px rgba(43, 90, 143, 0.2);
        }

        /* Button Primary */
        .button-primary {
            padding: var(--hs-spacing-md) var(--hs-spacing-xl); /* Larger padding */
            background-color: var(--hs-color-primary-medium);
            color: var(--hs-color-neutral-white);
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1em;
            cursor: pointer;
            text-decoration: none;
            border: none;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            min-width: 120px; /* Ensure button has minimum width */
        }

        .button-primary:hover {
            background-color: var(--hs-color-primary-dark);
            transform: translateY(-1px);
        }

        /* Button Outline */
        .button-outline {
            background-color: transparent;
            color: var(--hs-color-primary-dark);
            border-color: var(--hs-color-primary-dark);
            border: 1px solid; /* Explicit border */
            padding: var(--hs-spacing-md) var(--hs-spacing-xl);
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1em;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); /* Lighter shadow */
            min-width: 120px;
        }

        .button-outline:hover {
            background-color: var(--hs-color-primary-dark);
            color: var(--hs-color-neutral-white);
            border-color: var(--hs-color-primary-dark);
        }
        
        /* Search Results Placeholder */
        .search-results-placeholder {
            background-color: var(--hs-color-neutral-white);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: var(--hs-spacing-xl);
            border: 1px solid var(--hs-color-neutral-medium-grey);
            min-height: 200px; /* Give some visual height */
            display: flex;
            flex-direction: column; /* Stack text vertically */
            justify-content: center;
            align-items: center;
            color: var(--hs-color-neutral-dark-grey);
            font-style: italic;
            font-size: 1.1em;
            text-align: center;
            position: relative; /* For loading indicator */
        }
        .search-results-placeholder p {
            margin-bottom: var(--hs-spacing-sm);
        }

        /* Loading Indicator */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none; /* Hidden by default */
            border: 4px solid var(--hs-color-neutral-medium-grey);
            border-top: 4px solid var(--hs-color-primary-medium);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Changed to flex-start to align modal to top */
            z-index: 1000; /* Ensure it's on top */
            visibility: hidden; /* Hidden by default */
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            overflow-y: auto; /* Allow scrolling within the modal if content is long */
            padding-top: var(--hs-spacing-xxl); /* Add padding from the top */
            padding-bottom: var(--hs-spacing-xxl); /* Add padding at the bottom */
        }

        .modal-overlay.show {
            visibility: visible;
            opacity: 1;
        }

        .modal-content {
            background-color: var(--hs-color-neutral-white);
            border-radius: 10px; /* Slightly more rounded */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2); /* More prominent shadow */
            padding: var(--hs-spacing-xxl);
            width: 90%;
            max-width: 600px; /* Wider modal for patient form */
            position: relative;
            transform: scale(0.95); /* Start slightly smaller */
            transition: transform 0.3s ease;
            margin: var(--hs-spacing-lg) auto; /* Center with some margin for smaller screens */
            max-height: 90vh; /* Ensure modal content doesn't exceed viewport height */
            overflow-y: auto; /* Enable scrolling for content within modal */
        }

        .modal-overlay.show .modal-content {
            transform: scale(1); /* Scale up when shown */
        }

        .modal-close-button {
            position: absolute;
            top: var(--hs-spacing-md);
            right: var(--hs-spacing-md);
            background: none;
            border: none;
            font-size: 1.8em;
            color: var(--hs-color-neutral-dark-grey);
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .modal-close-button:hover {
            color: var(--hs-color-primary-dark);
        }

        .modal-content h2 {
            font-size: 1.8em; /* Slightly smaller heading for modal */
            margin-bottom: var(--hs-spacing-xl);
            color: var(--hs-color-primary-dark);
            text-align: center;
        }

        /* Form Group */
        .form-group {
            margin-bottom: var(--hs-spacing-lg); /* More space between fields in modal */
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: var(--hs-spacing-sm);
            font-weight: 500;
            color: var(--hs-color-primary-dark);
            font-size: 0.95em; /* Slightly smaller label */
        }

        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--hs-spacing-md); /* Larger input fields */
            border: 1px solid var(--hs-color-neutral-medium-grey);
            border-radius: 6px; /* Slightly more rounded */
            font-family: var(--hs-font-primary);
            font-size: 1.05em; /* Slightly larger text in input */
            color: var(--hs-color-neutral-text-dark);
            background-color: var(--hs-color-neutral-white);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--hs-color-primary-medium);
            outline: none;
            box-shadow: 0 0 0 3px rgba(43, 90, 143, 0.2);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Meta / Additional Info Styles */
        .meta-field-group {
            border: 1px solid var(--hs-color-neutral-medium-grey);
            border-radius: 5px;
            padding: var(--hs-spacing-md);
            margin-bottom: var(--hs-spacing-md);
            background-color: var(--hs-color-neutral-light-grey);
            display: flex;
            flex-wrap: wrap;
            gap: var(--hs-spacing-sm);
            align-items: flex-end; /* Align inputs and button at bottom */
        }
        .meta-field-group .form-group { /* Target form-group inside meta-field-group */
            flex: 1 1 calc(50% - var(--hs-spacing-sm)); /* Two columns for key/value */
            margin-bottom: 0; /* Remove default margin */
        }
        .meta-field-group .form-group:last-of-type {
            margin-bottom: 0; /* Ensure last form group has no bottom margin */
        }
        .meta-field-group button.remove-meta-field {
            background-color: var(--hs-color-alert-error);
            color: white;
            border: none;
            border-radius: 4px;
            padding: var(--hs-spacing-sm) var(--hs-spacing-md);
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.9em;
            height: fit-content; /* Adjust height to fit content */
        }
        .meta-field-group button.remove-meta-field:hover {
            background-color: #A0303E; /* Darker red */
        }

        .add-meta-field-button {
            display: inline-block;
            background-color: var(--hs-color-accent-aqua);
            color: var(--hs-color-neutral-white);
            padding: var(--hs-spacing-sm) var(--hs-spacing-md);
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s ease;
            border: none;
            margin-top: var(--hs-spacing-md); /* Space above button */
            font-size: 0.9em;
        }

        .add-meta-field-button:hover {
            background-color: var(--hs-color-accent-green);
        }


        /* Modal Form Submission Button */
        .button-modal-submit {
            display: block;
            width: 100%;
            padding: var(--hs-spacing-md);
            margin-top: var(--hs-spacing-xl); /* More space above modal button */
            background-color: var(--hs-color-accent-green); /* Use accent green for submit */
            color: var(--hs-color-neutral-white);
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.15em;
            cursor: pointer;
            text-decoration: none;
            border: none;
            transition: background-color 0.3s ease;
        }

        .button-modal-submit:hover {
            background-color: var(--hs-color-primary-dark);
        }

        /* Utility class to prevent body scroll when modal is open */
        body.no-scroll {
            overflow: hidden;
        }

        /* Custom Message Box for API Responses */
        .custom-message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--hs-color-neutral-white);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            padding: var(--hs-spacing-xl);
            z-index: 1001; /* Above modal overlay */
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            text-align: center;
            max-width: 400px;
            border: 1px solid var(--hs-color-neutral-medium-grey);
        }
        .custom-message-box p {
            margin-bottom: var(--hs-spacing-lg);
            font-size: 1.1em;
        }
        .custom-message-box .close-btn {
            background-color: var(--hs-color-primary-medium);
            color: var(--hs-color-neutral-white);
            padding: var(--hs-spacing-sm) var(--hs-spacing-md);
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .custom-message-box .close-btn:hover {
            background-color: var(--hs-color-primary-dark);
        }
        .custom-message-box.success {
            border-color: var(--hs-color-accent-green); /* Success green */
            color: var(--hs-color-accent-green);
        }
        .custom-message-box.error {
            border-color: #DC3545; /* Bootstrap Red */
            color: #DC3545;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header nav ul {
                gap: var(--hs-spacing-md);
            }
            .main-content h1 {
                font-size: 2em;
            }
            .search-container {
                flex-direction: column; /* Stack input and button */
                gap: var(--hs-spacing-lg);
            }
            .search-container .form-group {
                width: 100%; /* Full width for input */
            }
            .button-primary, .button-secondary, .button-outline { /* Include outline button */
                width: 100%; /* Full width for button */
            }
            .modal-content {
                padding: var(--hs-spacing-xl);
            }
            /* Adjust form columns for smaller screens */
            .form-columns {
                grid-template-columns: 1fr; /* Single column on smaller screens */
            }
            .meta-field-group .form-group {
                flex: 1 1 100%; /* Stack key/value vertically on small screens */
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: var(--hs-spacing-md) var(--hs-spacing-lg);
            }
            .header .logo {
                font-size: 1.5em;
            }
            .header nav ul {
                display: none; /* Hide nav on very small screens, could add a hamburger menu later */
            }
            .main-content h1 {
                font-size: 1.8em;
                margin-bottom: var(--hs-spacing-xl);
            }
            .search-container {
                padding: var(--hs-spacing-lg);
            }
            .search-container input[type="text"], .button-primary, .button-secondary, .button-outline { /* Include outline button */
                font-size: 1em;
                padding: var(--hs-spacing-sm) var(--hs-spacing-md);
            }
            .modal-content {
                padding: var(--hs-spacing-lg);
            }
            .modal-content h2 {
                font-size: 1.5em;
            }
        }

        /* New styles for two-column form layout */
        .form-columns {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two equal columns */
            gap: var(--hs-spacing-lg); /* Space between columns and rows */
            margin-bottom: var(--hs-spacing-lg); /* Space below the column layout */
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="#" class="logo">HealthSyncIQ</a>
        <nav>
            <ul>
                <!-- Dashboard link, now explicitly pointing to dashboard.html and active -->
                <li><a href="dashboard.html" class="active">Dashboard</a></li> 
                <!-- Patient Records link removed as requested -->
                <!-- Settings link, pointing to settings.html -->
                <li><a href="settings.html">Settings</a></li>
            </ul>
        </nav>
    </header>

    <main class="main-content">
        <h1>Patient Management Hub</h1>
        <p style="text-align: center; margin-bottom: var(--hs-spacing-xxl);">Enter a patient's registration number to access and manage their comprehensive medical records, or add a new patient.</p>
        
        <div class="search-container">
            <div class="form-group">
                <label for="registration-number">Enter Patient Registration Number</label>
                <input type="text" id="registration-number" placeholder="e.g., HS-GUZJ0G" required>
            </div>
            <button id="searchButton" class="button-primary">Search Patient</button>
            <!-- Changed to button-outline for less prominence -->
            <button id="addNewPatientButton" class="button-outline">Add New Patient</button> 
        </div>

        <div id="searchResults" class="search-results-placeholder">
            Search results or patient management options will appear here.
            <div class="loading-indicator" id="searchLoadingIndicator"></div>
        </div>
    </main>

    <!-- New Patient Modal -->
    <div id="newPatientModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button id="closeNewPatientModal" class="modal-close-button">&times;</button>
            <h2>Register New Patient</h2>
            <form id="newPatientForm">
                <div class="form-columns">
                    <div class="form-group">
                        <label for="new-patient-surname">Surname <span style="color:red">*</span></label>
                        <input type="text" id="new-patient-surname" name="surname" required>
                    </div>
                    <div class="form-group">
                        <label for="new-patient-first-name">First Name <span style="color:red">*</span></label>
                        <input type="text" id="new-patient-first-name" name="first_name" required>
                    </div>
                    <div class="form-group">
                        <label for="new-patient-last-name">Last Name</label>
                        <input type="text" id="new-patient-last-name" name="last_name">
                    </div>
                    <div class="form-group">
                        <label for="new-patient-dob">Date of Birth</label>
                        <input type="date" id="new-patient-dob" name="dob">
                    </div>
                    <div class="form-group">
                        <label for="new-patient-genotype">Genotype</label>
                        <select id="new-patient-genotype" name="genotype">
                            <option value="">Select Genotype</option>
                            <option value="AA">AA</option>
                            <option value="AS">AS</option>
                            <option value="SS">SS</option>
                            <option value="AC">AC</option>
                            <option value="SC">SC</option>
                            <option value="CC">CC</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="new-patient-blood-group">Blood Group</label>
                        <select id="new-patient-blood-group" name="blood_group">
                            <option value="">Select Blood Group</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="new-patient-gender">Gender</label>
                        <select id="new-patient-gender" name="gender">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="new-patient-email">Email <span style="color:red">*</span></label>
                        <input type="email" id="new-patient-email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="new-patient-phone">Phone Number</label>
                        <input type="tel" id="new-patient-phone" name="phone_number" placeholder="e.g., +2348012345678">
                    </div>
                    <div class="form-group" style="grid-column: 1 / span 2;"> <!-- Make this span both columns -->
                        <label for="new-patient-contact-info">Contact Information</label>
                        <textarea id="new-patient-contact-info" name="contact_information" placeholder="Patient's address or general contact details"></textarea>
                    </div>
                    <div class="form-group" style="grid-column: 1 / span 2;"> <!-- Make this span both columns -->
                        <label for="new-patient-emergency-contact">Emergency Contact</label>
                        <textarea id="new-patient-emergency-contact" name="emergency_contact" placeholder="Name, relationship, phone number"></textarea>
                    </div>
                </div>
                
                <!-- New Meta / Additional Information Section (outside two columns for full width) -->
                <div class="form-group">
                    <label>Additional Information (Meta Data)</label>
                    <div id="meta-fields-container">
                        <!-- Dynamic meta fields will be appended here -->
                    </div>
                    <button type="button" id="addMetaFieldButton" class="add-meta-field-button">Add Additional Field</button>
                </div>

                <button type="submit" class="button-modal-submit">Register Patient</button>
            </form>
        </div>
    </div>

    <!-- Custom Message Box HTML -->
    <div id="customMessageBox" class="custom-message-box">
        <p id="messageBoxText"></p>
        <button class="close-btn" onclick="document.getElementById('customMessageBox').style.display='none';">Close</button>
    </div>

    <script>
        // --- API Configuration ---
        const API_BASE_URL = 'http://localhost:9000/api/v1';
        const SEARCH_PATIENT_ENDPOINT = '/patients'; // Base endpoint, registration_code will be part of URL path
        const NEW_PATIENT_ENDPOINT = '/patients'; // Endpoint for creating new patients

        // --- DOM Element References ---
        const searchButton = document.getElementById('searchButton');
        const addNewPatientButton = document.getElementById('addNewPatientButton');
        const registrationNumberInput = document.getElementById('registration-number');
        const searchResultsDiv = document.getElementById('searchResults');
        const searchLoadingIndicator = document.getElementById('searchLoadingIndicator');

        // New Patient Modal Elements
        const newPatientModalOverlay = document.getElementById('newPatientModalOverlay');
        const closeNewPatientModalBtn = document.getElementById('closeNewPatientModal');
        const newPatientForm = document.getElementById('newPatientForm');
        const metaFieldsContainer = document.getElementById('meta-fields-container');
        const addMetaFieldButton = document.getElementById('addMetaFieldButton');

        // Custom Message Box Elements
        const customMessageBox = document.getElementById('customMessageBox');
        const messageBoxText = document.getElementById('messageBoxText');

        // --- Utility Functions ---

        // Function to show a custom message box
        function showCustomMessage(message, type) {
            messageBoxText.textContent = message;
            customMessageBox.className = 'custom-message-box ' + type; // Add type class for styling (success/error)
            customMessageBox.style.display = 'flex'; // Show the message box
            // Optionally, hide after a few seconds for success messages
            if (type === 'success') {
                setTimeout(hideCustomMessage, 3000); 
            }
        }

        // Function to hide a custom message box
        function hideCustomMessage() {
            customMessageBox.style.display = 'none';
            messageBoxText.textContent = '';
            customMessageBox.className = 'custom-message-box';
        }

        // Function to show/hide loading indicator
        function showLoading(show) {
            if (show) {
                searchResultsDiv.innerHTML = ''; // Clear previous results
                searchLoadingIndicator.style.display = 'block';
                searchResultsDiv.style.minHeight = '200px'; // Ensure space for spinner
            } else {
                searchLoadingIndicator.style.display = 'none';
            }
        }

        // Function to add a new meta key-value pair row
        function addMetaField(key = '', value = '') {
            const fieldGroup = document.createElement('div');
            fieldGroup.className = 'meta-field-group';
            fieldGroup.innerHTML = `
                <div class="form-group">
                    <label>Key</label>
                    <input type="text" class="meta-key-input" value="${key}" placeholder="e.g., allergies" required>
                </div>
                <div class="form-group">
                    <label>Value</label>
                    <input type="text" class="meta-value-input" value="${value}" placeholder="e.g., Penicillin">
                </div>
                <button type="button" class="remove-meta-field">Remove</button>
            `;
            metaFieldsContainer.appendChild(fieldGroup);

            // Add event listener to the new remove button
            fieldGroup.querySelector('.remove-meta-field').addEventListener('click', () => {
                fieldGroup.remove();
            });
        }

        // Function to show the new patient modal
        function showNewPatientModal() {
            console.log('Attempting to show new patient modal.'); // Debugging log
            hideCustomMessage(); // Clear any previous messages
            newPatientModalOverlay.classList.add('show');
            document.body.classList.add('no-scroll'); // Prevent body scrolling
            metaFieldsContainer.innerHTML = ''; // Clear existing meta fields before adding a new one
            addMetaField(); // Add one empty meta field by default for easier entry
        }

        // Function to hide the new patient modal and reset form
        function hideNewPatientModal() {
            newPatientModalOverlay.classList.remove('show');
            document.body.classList.remove('no-scroll'); // Allow body scrolling
            newPatientForm.reset(); // Reset form fields
            // Clear specific fields if needed
            newPatientForm.querySelector('#new-patient-dob').value = ''; 
            newPatientForm.querySelector('#new-patient-gender').value = ''; 
            newPatientForm.querySelector('#new-patient-genotype').value = ''; 
            newPatientForm.querySelector('#new-patient-blood-group').value = ''; 
            metaFieldsContainer.innerHTML = ''; // Clear all dynamic meta fields
            hideCustomMessage(); // Ensure message box is hidden when modal closes
        }

        // --- Event Listeners ---

        // Event listener for the "Search Patient" button
        searchButton.addEventListener('click', async () => {
            const regNumber = registrationNumberInput.value.trim();
            hideCustomMessage(); // Clear any previous messages
            searchResultsDiv.innerHTML = ''; // Clear previous results display
            searchResultsDiv.style.color = 'var(--hs-color-neutral-dark-grey)';
            searchResultsDiv.style.fontStyle = 'italic';
            searchResultsDiv.style.textAlign = 'center';

            if (!regNumber) {
                showCustomMessage('Please enter a registration number to search.', 'error');
                return;
            }

            // Show loading indicator
            showLoading(true);

            const authToken = sessionStorage.getItem('authToken');
            if (!authToken) {
                showLoading(false);
                showCustomMessage('Error: Not authenticated. Redirecting to login.', 'error');
                console.error('Authentication token not found in session storage. Redirecting to index.html.');
                window.location.href = 'index.html'; // Redirect to index.html
                return;
            }
            console.log('Attempting patient search with authToken:', authToken); // Debugging log

            try {
                // Construct the full URL for the search endpoint
                const fullSearchUrl = `${API_BASE_URL}${SEARCH_PATIENT_ENDPOINT}/${regNumber}/search-by-registration-code`;
                console.log('Fetching from:', fullSearchUrl);

                const response = await fetch(fullSearchUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}` 
                    },
                });

                showLoading(false); // Hide loading indicator once response is received

                if (response.ok) { // Status 200-299
                    const data = await response.json();
                    console.log('Search successful:', data);

                    if (data.data && Array.isArray(data.data) && data.data.length > 0) {
                        let patientsHtml = '<h3>Patients Found:</h3>';
                        data.data.forEach(patient => {
                            patientsHtml += `
                                <div style="text-align: left; padding: var(--hs-spacing-md); border-bottom: 1px solid var(--hs-color-neutral-medium-grey); margin-bottom: var(--hs-spacing-md);">
                                    <p><strong>ID:</strong> ${patient.id}</p>
                                    <p><strong>Registration Code:</strong> ${patient.registration_code}</p>
                                    <p><strong>Name:</strong> ${patient.first_name || ''} ${patient.last_name || ''} ${patient.surname || ''}</p>
                                    <button class="button-primary" style="margin-top: var(--hs-spacing-md);">View Full Record</button>
                                </div>
                            `;
                        });
                        searchResultsDiv.innerHTML = patientsHtml;
                        searchResultsDiv.style.color = 'var(--hs-color-neutral-text-dark)';
                        searchResultsDiv.style.fontStyle = 'normal';
                        searchResultsDiv.style.textAlign = 'left';
                        showCustomMessage('Patient(s) found successfully!', 'success'); // Success pop-up
                    } else {
                        searchResultsDiv.innerHTML = `<p style="color: var(--hs-color-status-info);">No patient found with registration code: <strong>${regNumber}</strong>.</p>`;
                        searchResultsDiv.style.color = 'var(--hs-color-status-info)';
                        searchResultsDiv.style.fontStyle = 'italic';
                        searchResultsDiv.style.textAlign = 'center';
                        showCustomMessage(`No patient found with registration code: ${regNumber}.`, 'error'); // Info/error pop-up
                    }

                } else if (response.status === 401) {
                    const errorData = await response.json();
                    searchResultsDiv.innerHTML = `<p style="color: var(--hs-color-alert-error);">Authentication Required: Please log in again.</p>`;
                    searchResultsDiv.style.textAlign = 'center';
                    showCustomMessage('Authentication Required: Please log in again. Redirecting to login.', 'error'); // Error pop-up
                    console.error('Search failed - Unauthorized:', errorData);
                    window.location.href = 'index.html'; // Redirect to index.html
                } else if (response.status === 403) { // Added 403 check
                    const errorData = await response.json();
                    searchResultsDiv.innerHTML = `<p style="color: var(--hs-color-alert-error);">Insufficient Permissions: You do not have access to view this patient.</p>`;
                    searchResultsDiv.style.textAlign = 'center';
                    showCustomMessage('Error: Insufficient Permissions to view patient records.', 'error');
                    console.error('Search failed - Forbidden:', errorData);
                } else if (response.status === 404) {
                    searchResultsDiv.innerHTML = `<p style="color: var(--hs-color-status-info);">Patient with registration code <strong>${regNumber}</strong> not found.</p>`;
                    searchResultsDiv.style.color = 'var(--hs-color-status-info)';
                    searchResultsDiv.style.fontStyle = 'italic';
                    searchResultsDiv.style.textAlign = 'center';
                    showCustomMessage(`Patient with registration code ${regNumber} not found.`, 'error'); // Error pop-up
                } else {
                    const errorData = await response.json();
                    const errorMessage = errorData.message || 'An unexpected error occurred.';
                    searchResultsDiv.innerHTML = `<p style="color: var(--hs-color-alert-error);">Error searching: ${errorMessage}</p>`;
                    searchResultsDiv.style.textAlign = 'center';
                    showCustomMessage(`Error searching: ${errorMessage}.`, 'error'); // Error pop-up
                    console.error('Search failed:', response.status, errorData);
                }
            } catch (error) {
                showLoading(false); // Hide loading on network error
                searchResultsDiv.innerHTML = `<p style="color: var(--hs-color-alert-error);">Network error: Could not connect to the server. Please try again.</p>`;
                searchResultsDiv.style.textAlign = 'center';
                showCustomMessage('Network error: Could not connect to the server. Please try again.', 'error'); // Error pop-up
                console.error('Network error during patient search:', error);
            }
        });

        // Event listener for the "Add New Patient" button - now shows modal
        addNewPatientButton.addEventListener('click', showNewPatientModal);

        // Event listeners for new patient modal close
        closeNewPatientModalBtn.addEventListener('click', hideNewPatientModal);
        newPatientModalOverlay.addEventListener('click', (event) => {
            if (event.target === newPatientModalOverlay) {
                hideNewPatientModal();
            }
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && newPatientModalOverlay.classList.contains('show')) {
                hideNewPatientModal();
            }
        });

        // Event listener for adding new meta fields
        addMetaFieldButton.addEventListener('click', () => addMetaField());

        // Form submission handler for new patient
        newPatientForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission
            hideCustomMessage(); // Clear any previous messages

            console.log('New patient form submission initiated.'); // Debugging log

            const formData = new FormData(newPatientForm);
            const patientData = {};
            for (let [key, value] of formData.entries()) {
                // For regular form fields, if empty, set to null
                if (value === '') { 
                    patientData[key] = null;
                } else {
                    patientData[key] = value;
                }
            }

            // Explicitly handle fields that are now selects or need specific parsing
            patientData.dob = patientData.dob === '' ? null : patientData.dob;
            patientData.genotype = patientData.genotype === '' ? null : patientData.genotype;
            patientData.blood_group = patientData.blood_group === '' ? null : patientData.blood_group;
            patientData.gender = patientData.gender === '' ? null : patientData.gender;


            // Handle dynamic meta fields
            const metaInputs = metaFieldsContainer.querySelectorAll('.meta-field-group');
            const metaDataArray = []; // Changed to array
            let hasDuplicateMetaKey = false;

            metaInputs.forEach(group => {
                const keyInput = group.querySelector('.meta-key-input');
                const valueInput = group.querySelector('.meta-value-input');
                const key = keyInput.value.trim();
                const value = valueInput.value.trim();

                if (key !== '') { // Only add if key is not empty
                    // Check for duplicate keys within the array of objects
                    const isDuplicate = metaDataArray.some(item => item.key === key);
                    if (isDuplicate) {
                        hasDuplicateMetaKey = true;
                        keyInput.style.borderColor = 'red'; 
                    }
                    metaDataArray.push({ key: key, value: value }); // Push object into array
                }
            });

            if (hasDuplicateMetaKey) {
                showCustomMessage("Error: Duplicate keys found in Additional Information. Please use unique keys.", "error");
                console.error("Duplicate meta keys detected."); // Debugging log
                return; // Prevent form submission
            }
            
            // Assign the constructed meta array, or null if empty
            patientData.meta = metaDataArray.length > 0 ? metaDataArray : null; 

            console.log('New Patient Data for submission:', patientData); // Debugging log
            
            const authToken = sessionStorage.getItem('authToken');
            if (!authToken) {
                showCustomMessage('Error: Not authenticated. Redirecting to login.', 'error');
                console.error('Authentication token not found for new patient registration. Stopping submission. Redirecting to index.html.'); // Debugging log
                window.location.href = 'index.html'; // Redirect to index.html
                return;
            }
            console.log('Authentication token found. Proceeding with fetch request.'); // Debugging log

            try {
                const response = await fetch(`${API_BASE_URL}${NEW_PATIENT_ENDPOINT}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}` 
                    },
                    body: JSON.stringify(patientData),
                });
                console.log('Fetch request sent. Awaiting response.'); // Debugging log

                if (response.status === 201) { // Specifically check for 201 Created
                    const result = await response.json();
                    console.log('Patient registered successfully:', result);
                    // Use the message from the API response
                    showCustomMessage(`Patient registered successfully! ID: ${result.data.id}. Message: ${result.data.message}`, 'success');
                    hideNewPatientModal();
                } else if (response.status === 401) {
                    const error = await response.json();
                    console.error('Failed to register patient - Unauthorized:', error);
                    showCustomMessage('Authentication Required: Please log in again. Redirecting to login.', 'error');
                    window.location.href = 'index.html'; // Redirect to index.html
                } else if (response.status === 403) { // Added 403 check
                    const error = await response.json();
                    console.error('Failed to register patient - Forbidden:', error);
                    showCustomMessage('Error: Insufficient Permissions to register new patient.', 'error');
                } else {
                    const error = await response.json();
                    console.error('Failed to register patient:', error);
                    showCustomMessage('Failed to register patient: ' + (error.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Network error during patient registration:', error);
                showCustomMessage('An error occurred during registration. Please check your network.', 'error');
            }
        });

        // Optional: Trigger search on Enter key press in the input field
        registrationNumberInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission if any
                searchButton.click(); // Simulate button click
            }
        });
    </script>
</body>
</html>
